services:
  # Development container with full tooling
  devcon-cpp:
    build:
      context: .
      dockerfile: Containerfile
      target: development
      args:
        - BUILD_JOBS=8
        - USERNAME=developer
        - USER_UID=1000
        - USER_GID=1000
      cache_from:
        - type=registry,ref=your-username/devcon-cpp:buildcache-development
      cache_to:
        - type=registry,ref=your-username/devcon-cpp:buildcache-development,mode=max
    image: devcon-cpp:development
    container_name: devcon-cpp-workspace

    # Capabilities for debugging
    cap_add:
      - SYS_PTRACE
    security_opt:
      - seccomp:unconfined
      - apparmor:unconfined

    # Mount source code
    volumes:
      - ./:/workspace:cached
      - cpp-dev-cache:/home/developer/.cache
      - cpp-dev-vscode:/home/developer/.vscode-server

    working_dir: /workspace

    # Keep container running
    command: sleep infinity

    # Environment variables
    environment:
      - CMAKE_EXPORT_COMPILE_COMMANDS=1
      - TERM=xterm-256color

    # Network for service communication
    networks:
      - devcon-cpp-network

    # Resource limits (adjust as needed)
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 8G
        reservations:
          cpus: '2'
          memory: 2G

  # Lightweight runtime container for testing
  devcon-cpp-runtime:
    build:
      context: .
      dockerfile: Containerfile
      target: runtime
      args:
        - BUILD_JOBS=8
    image: devcon-cpp:runtime
    container_name: devcon-cpp-runtime-test

    volumes:
      - ./:/workspace:ro  # Read-only mount for testing

    working_dir: /workspace
    command: sleep infinity

    networks:
      - devcon-cpp-network

  # Example gRPC server for testing
  grpc-server:
    image: devcon-cpp:runtime
    container_name: devcon-cpp-grpc-server

    volumes:
      - ./examples:/workspace:ro

    working_dir: /workspace

    # Override command to run your gRPC server
    command: /workspace/build/server

    ports:
      - "50051:50051"

    networks:
      - devcon-cpp-network

    depends_on:
      - devcon-cpp

networks:
  devcon-cpp-network:
    driver: bridge
    name: devcon-cpp-network

volumes:
  # Persistent cache for faster builds
  cpp-dev-cache:
    name: cpp-dev-cache

  # VS Code server extensions
  cpp-dev-vscode:
    name: cpp-dev-vscode
